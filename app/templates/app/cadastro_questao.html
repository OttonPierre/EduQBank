{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastrar Questão</title>
  
  <link rel="stylesheet" href="{% static 'app/css/bootstrap.min.css' %}" />

  {{ form.media }}

  <style>
    body {
      background-color: #f8f9fa;
    }

    .form-container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 50px;
      margin-bottom: 50px; /* Adicionado espaço inferior */
    }

    .form-title {
      font-weight: 600;
      font-size: 24px;
      margin-bottom: 25px;
    }

    .form-label {
      font-weight: 500;
    }

    /* Estilo opcional, mas recomendado:
      Define uma altura mínima para os editores CKEditor 5.
    */
    .ck-editor__editable_inline {
        min-height: 250px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
      <div class="form-container">
        <div class="form-title">Cadastrar Nova Questão</div>

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data" action="">
          {% csrf_token %}

          <h5 class="text-primary">Classificação</h5>
          <hr class="mt-2 mb-3">

          <div class="mb-3">
            <label for="area" class="form-label">Área</label>
            <select name="area" id="area" class="form-select" required>
              <option value="">Selecione</option>
              {% for area in areas %}
                <option value="{{ area.id }}">{{ area.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="unidade" class="form-label">Unidade</label>
            <select name="unidade" id="unidade" class="form-select" disabled>
              <option value="">Selecione primeiro a Área</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="topico" class="form-label">Tópico</label>
            <select name="topico" id="topico" class="form-select" disabled>
              <option value="">Selecione primeiro a Unidade</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="subtopico" class="form-label">Subtópico</label>
            <select name="subtopico" id="subtopico" class="form-select" disabled>
              <option value="">Selecione primeiro o Tópico</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="categoria" class="form-label">Categoria</label>
            <select name="categoria" id="categoria" class="form-select" disabled>
              <option value="">Selecione primeiro o Subtópico</option>
            </select>
          </div>

          <h5 class="text-primary mt-4">Informações Adicionais</h5>
          <hr class="mt-2 mb-3">

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="ano" class="form-label">Ano</label>
              <input type="number" name="ano" id="ano" class="form-control" min="1900" max="2030" placeholder="Ex: 2025" required>
            </div>

            <div class="col-md-6 mb-3">
              <label for="banca" class="form-label">Banca</label>
              <select name="banca" id="banca" class="form-select" required>
                <option value="">Selecione</option>
                <option value="N_IDENTIFICADA">Não identificada</option>
                <option value="ENEM">Enem</option>
                <option value="FGV">FGV</option>
                <option value="FUVEST">Fuvest</option>
                <option value="EDUQBANK">EduQbank</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="tipo_questao" class="form-label">Tipo de Questão</label>
              <select name="tipo_questao" id="tipo_questao" class="form-select" required>
                <option value="">Selecione</option>
                <option value="multipla_escolha">Múltipla escolha</option>
                <option value="discursiva">Discursiva</option>
                <option value="verdadeiro_falso">Verdadeiro ou falso</option>
                <option value="somatorio">Somatório</option>
                <option value="multiplas_respostas">Múltiplas respostas</option>
                <option value="analitica">Analítica (dissertativa)</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="dificuldade" class="form-label">Nível de Dificuldade</label>
              <select name="dificuldade" id="dificuldade" class="form-select" required>
                <option value="">Selecione</option>
                <option value="Fácil">Fácil</option>
                <option value="Média">Média</option>
                <option value="Difícil">Difícil</option>
              </select>
            </div>
          </div>

          <h5 class="text-primary mt-4">Conteúdo da Questão</h5>
          <hr class="mt-2 mb-3">

          <div class="mb-4">
            <label for="{{ form.enunciado.id_for_label }}" class="form-label">Enunciado</label>
            {{ form.enunciado }}
          </div>

          <div class="mb-4">
            <label for="{{ form.resposta.id_for_label }}" class="form-label">Resposta</label>
            {{ form.resposta }}
          </div>

          <div class="d-flex flex-column align-items-center mt-4 mb-4">
            <button type="submit" class="btn btn-primary w-75 btn-lg fw-bold mb-3">
              Cadastrar Questão
            </button>

            <a href="/" class="btn btn-secondary w-50 btn-lg" role="button">
              Voltar ao Início
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="{% static 'app/js/bootstrap.bundle.min.js' %}"></script>

<script>
  // Executa o script apenas quando o DOM estiver pronto
  $(function() {
    
    // Armazena a URL em uma constante
    const BUSCAR_CONTEUDOS_URL = "{% url 'buscar_conteudos' %}";

    function carregarFilhos(pai_id, seletor_filho) {
      const $seletorFilho = $(seletor_filho); // Cache do seletor jQuery

      // Limpa e desabilita o seletor filho
      let placeholder = '<option value="">Selecione</option>';
      if (!pai_id) {
        $seletorFilho.html(placeholder).prop('disabled', true);
        return;
      }
      
      // Atualiza o placeholder enquanto carrega
      $seletorFilho.html('<option value="">Carregando...</option>').prop('disabled', true);

      // Requisição AJAX
      $.get(BUSCAR_CONTEUDOS_URL, { pai_id: pai_id }, function(data) {
        let options = '<option value="">Selecione</option>';
        
        // Verifica se 'data' é um array antes de usar forEach
        if (Array.isArray(data)) {
          data.forEach(function(item) {
            options += `<option value="${item.id}">${item.nome}</option>`;
          });
        }
        
        $seletorFilho.html(options).prop('disabled', false);
      })
      .fail(function() {
        // Adiciona tratamento de erro
        console.error("Falha ao carregar dados para: " + seletor_filho);
        $seletorFilho.html('<option value="">Erro ao carregar</option>').prop('disabled', true);
      });
    }

    // --- Event Listeners ---

    $('#area').on('change', function() {
      carregarFilhos(this.value, '#unidade');
      // Reseta todos os campos filhos
      $('#topico, #subtopico, #categoria').html('<option value="">Selecione</oção>').prop('disabled', true);
    });

    $('#unidade').on('change', function() {
      carregarFilhos(this.value, '#topico');
      $('#subtopico, #categoria').html('<option value="">Selecione</option>').prop('disabled', true);
    });

    $('#topico').on('change', function() {
      carregarFilhos(this.value, '#subtopico');
      $('#categoria').html('<option value="">Selecione</option>').prop('disabled', true);
    });

    $('#subtopico').on('change', function() {
      carregarFilhos(this.value, '#categoria');
    });
  });
</script>

</body>
</html>